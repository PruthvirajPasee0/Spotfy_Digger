<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Digger</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="main-layout">
        <div id="container" class="card main-content">
            <h1>Spotify Digger</h1>
            <p>Download your favorite Spotify tracks or entire playlists as high-quality MP3s in a convenient ZIP file.
            </p>
            <form method="POST" id="download-form">
                <div>
                    <input type="text" name="spotify_url" placeholder="e.g., https://open.spotify.com/playlist/..."
                        required>
                </div>
                <button type="submit">Download</button>
            </form>
            {% if error %}
            <p class="text-danger show">{{ error }}</p>
            {% endif %}
            <div id="playlist-container" style="display: none;">
                <h2>Select Songs to Download</h2>
                <form id="playlist-form">
                    <ul id="song-list">
                    </ul>
                    <button type="submit">Download Selected</button>
                </form>
            </div>

            <div id="progress-bar">
                <div role="progressbar" style="width: 0%;" id="progress-fill"></div>
            </div>
            <span id="progress-percentage-text">0%</span> 
            <p id="progress-message"></p>
            <a href="/download" id="download-link" style="display: none;">Download ZIP</a>
        </div>

        <div class="features-column">
            <div class="card feature-card">
                <h2>ðŸ“ˆ Efficient Batch Downloads</h2>
                <p>Easily download multiple tracks or entire playlists in one go. Our intelligent system handles large
                    queues efficiently, ensuring a smooth experience.</p>
            </div>
            <div class="card feature-card">
                <h2>ðŸ¤– AI-Powered Suggestions</h2>
                <p>Leverage our experimental AI feature to receive tailored track suggestions based on your listening
                    habits and download history. (Coming soon!)</p>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {

            $("#download-form").submit(function (e) {
                e.preventDefault();
                const url = $('input[name="spotify_url"]').val();


                $("#progress-message").removeClass("text-danger show").text("");
                $("#download-link").hide();
                $("#progress-bar").hide();
                $("#progress-percentage-text").hide().removeClass("show").text("0%");
                $("#progress-fill").css("width", "0%");
                $("#playlist-container").hide();


                if (url.includes("/playlist/")) {
                    fetchPlaylistTracks(url);
                } else if (url.includes("/track/")) {

                    const songName = url;
                    startDownloadTask({ songs: [{ name: songName, artist: "Unknown Artist" }] });
                } else {
                    $("#progress-message").addClass("text-danger show").text("Please enter a valid Spotify track or playlist URL.");
                }
            });

            function fetchPlaylistTracks(url) {
                $("#progress-message").text("Fetching playlist tracks...").addClass("show");
                $.ajax({
                    url: '/list_tracks',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ 'spotify_url': url }),
                    success: function (data) {
                        if (data.tracks && data.tracks.length > 0) {
                            displayTracks(data.tracks);
                            $("#progress-message").removeClass("show").text("");
                        } else {

                            $("#progress-message").addClass("text-danger show").text("Playlist is empty or private. No tracks to display.");
                        }
                    },
                    error: function (xhr, status, error) {
                        const errorMessage = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : "Failed to fetch playlist tracks. Please check the URL or try again.";
                        $("#progress-message").addClass("text-danger show").text(errorMessage);
                    }
                });
            }

            function displayTracks(tracks) {
                $("#download-form").hide();
                const $songList = $("#song-list");
                $songList.empty();

                tracks.forEach((track, index) => {
                    const listItem = `
                <li>
                    <input type="checkbox" id="song-${index}" name="selected_songs" value='${JSON.stringify(track)}' checked>
                    <label for="song-${index}">${track.name} - ${track.artist}</label>
                </li>
            `;
                    $songList.append(listItem);
                });

                $("#playlist-container").show();


                $("#playlist-form").off('submit').on('submit', function (e) {
                    e.preventDefault();
                    const selectedSongs = [];
                    $('input[name="selected_songs"]:checked').each(function () {
                        selectedSongs.push(JSON.parse($(this).val()));
                    });

                    if (selectedSongs.length > 0) {
                        startDownloadTask({ songs: selectedSongs });
                    } else {
                        $("#progress-message").addClass("text-danger show").text("Please select at least one song to download.");
                    }
                });
            }

            function startDownloadTask(payload) {
                $("#download-form").hide();
                $("#playlist-container").hide();
                $("#progress-bar").show();
                $("#progress-percentage-text").show().addClass("show");
                $("#progress-message").text("Starting download...").addClass("show");

                $.ajax({
                    url: '/download_selected',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function (response) {
                        if (response.status === "download started") {
                            pollProgress();
                        } else {

                            $("#progress-message").addClass("text-danger show").text(response.message || "Download could not be started.");
                        }
                    },
                    error: function (xhr, status, error) {
                        const errorMessage = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : "Error starting download task. Please try again.";
                        $("#progress-message").addClass("text-danger show").text(errorMessage);
                    }
                });
            }

            function pollProgress() {
                let interval = setInterval(function () {
                    $.get('/progress', function (data) {
                        let percent = (data.current / data.total) * 100 || 0;
                        $("#progress-fill").css("width", percent + "%");
                        $("#progress-percentage-text").text(Math.round(percent) + "%");
                        $("#progress-message").text(data.message);

                        if (data.status === "done") {
                            clearInterval(interval);
                            $("#download-link").show();
                            $("#progress-message").removeClass("show");
                        } else if (data.status === "error") {
                            clearInterval(interval);
                            $("#progress-message").addClass("text-danger show").text("Download failed: " + data.message);
                            $("#download-link").hide();
                        }
                    }).fail(function () {
                        clearInterval(interval);
                        $("#progress-message").addClass("text-danger show").text("Failed to get progress updates. Please check your connection.");
                    });
                }, 1000);
            }
       })
    </script>
</body>
</html>